\section{Об оффлайн деревьях поиска: нижняя граница времени работы, геометрическое представление} \noteauthor{Борис Золотов}

\subsection{Основные определения и предваряющие результаты}

Пусть дано бинарное дерево поиска с $n$ ключами. Мы знаем последовательность запросов, которые зададим этому дереву: $P = \set{s_1,s_2,\ldots,s_m}$. В поисках ключей~$s_i$ мы будем бегать по дереву туда-сюда и в процессе спуска/подъёма пройдём через некоторые вершины, которые нам не нужны.

\newdefn{$E(P)$ — множество всех вершин, которые мы посетим в процессе поиска вершин с ключами из $P$. $E = P \cup X$, $X$ — множество «лишних» вершин.}

\newdefn{$\opt$ — минимальный размер $E(P)$ (обозначение множества $P$ будем опускать, и так по контексту ясно).}

\newdefn{Пусть $a, b \in \br^2$. Тогда $\rect (a,b)$ — прямоугольник, стороны которого параллельны осям координат, а противоположные вершины — точки $a$ и $b$. Его же будем называть {\it прямоугольник, определённый точками $a$, $b$.}}

\newdefn{Конечное множество $G \subset \br^2$ называется {\it\arbs,} если
	 \begin{align*}
&	\forall\,a,b \in G\quad x(a)=x(b)\text{,\ \ либо\ \ }
		y(a)=y(b)\text{,\ \ либо} \\
&	\exists\,c \in \rect (a,b)\text{\ \ (внутри или на границе).}
	 \end{align*}}

\begin{theorem}[Доказана ранее]
	Рассмотрим последовательность запросов
	\begin{equation*}
		\set{(s_1,1),(s_2,2),\ldots,(s_m,m)} \subset \bz^2.
	\end{equation*}

	Надмножество этой последовательности может представлять из себя последовательность узлов, которые были посещены при поиске $s_1, \ldots, s_m$, в том и только том случае, если оно \arbs.
\end{theorem}

\input{figs/rectEx}

Далее мы будем рассматривать изображение последовательности запросов на плоскости, соответственно под множеством $P$ будем понимать $\set{(s_1,1),(s_2,2),\ldots,(s_m,m)}$, аналогично вторую координату приделаем к ключам вершин из множества $E$.

\newdefn{
	Пусть дано множество $P$ и его надмножество $E$. Два прямоугольника,
	определённых каждый двумя вершинами множества $P$,
	будем называть {\it независимыми} (смотреть
	Рисунок~\ref{fig:rectIndependent}), если
\begin{enumerate}
	\item они оба не \arbs, то есть им не принадлежит ни одна точка из $E$,
	\item ни одна из вершин одного из этих прямоугольников не лежит во внутренности другого.
\end{enumerate}}

\subsection{Оценка снизу числа {\rm OPT}}

\newdefn{Будем говорить, что прямоугольник, определённый точками $(x_1, y_1)$, $(x_2, y_2)$, {\it имеет тип~«+»,} если $(x_1-x_2) \cdot (y_1-y_2) \ge 0$, иначе прямоугольник {\it имеет тип~«$-$\!»} (смотреть Рисунок~\ref{fig:recType}).}

\begin{figure}[h] \centering
\tikz[scale=0.7]{
\begin{scope}[xshift=-3 cm]
	\defrect{(-1.5,-1)}{(1.5,1)}{ }{ }; \draw (0,0) node{$+$};
\end{scope}
\begin{scope}[xshift=3 cm]
	\defrect{(-1.5,1)}{(1.5,-1)}{ }{ }; \draw (0,0) node{$-$};
\end{scope}
}
\caption{Прямоугольники типа \tpl и типа \tmi.}
\label{fig:recType}
\end{figure}

\newdefn{$\maxind$ — наибольшее число попарно независимых прямоугольников, определённых точками из $P$. Соответственно, $\maxind_+$, $\maxind_-$ — наибольшие количества попарно независимых прямоугольников фиксированного типа.}

\begin{theorem} \label{thm:optFirstBound}
\begin{equation}
	\label{eq:optFirstBound}
	\opt\ \ge\ |P| + \frac{1}{2} \maxind.
\end{equation}
\end{theorem}

Прежде чем приступить к доказательству Теоремы~\ref{thm:optFirstBound}, докажем следующую лемму:

\begin{lemma} \label{lm:optPlusBound}
\begin{equation}
	\label{eq:optPlusBound}
	\opt_+(P)\ \ge\ |P| + \frac{1}{2} \maxind_+ (P).
\end{equation}
\end{lemma}

Здесь $\opt_+$ — количество точек в множестве $E(P)$, нужное для того, чтобы множество всех прямоугольников типа~\tpl было \arbs. Это более слабое условие.

Далее мы забываем о том, что множества точек, с которыми мы работаем, — это вообще говоря выходы какой-то процедуры поиска, и рассматриваем произвольные конечные множества точек на плоскости.

\begin{proof}[Доказательство Леммы~\ref{lm:optPlusBound}]
Пусть все координаты точек из $P$ различны (точки можно чуть-чуть пошевелить, чтобы это стало так и ничего больше не нарушилось). Рассмотрим максимальный набор попарно независимых \tpl-прямоугольников и самый широкий из них — пусть он определён точками $a$, $b$. Некоторые прямоугольники будут пересекать наш самый широкий прямоугольник, одной из их вершин может быть $a$ или $b$, либо их определяющие вершины будут лежать за границами самого широкого прямоугольника, одна выше, одна ниже, смотреть Рисунок~\ref{fig:rectCases}.

\input{figs/optPlusBound}

Прямоугольники, имеющие своей вершиной $a$, не пересекаются с прямоугольниками, имеющими своей вершиной $b$, потому что иначе получается случай прямо как на Рисунке~\ref{fig:rectNotInd}. Более того, оставшиеся прямоугольники тоже не могут никак налезать друг на друга, потому что опять же получится случай с Рисунка~\ref{fig:rectNotInd}. Поэтому существует вертикальная линия, пересекающая {\it только} выбранный нами широкий прямоугольник $\rect (a,b)$, обозначим её через $\ell$, смотреть Рисунок~\ref{fig:rectPQ}.

Рассмотрим самую верхнюю, самую правую точку из $E(P)$, которая левее $\ell$ и принадлежит $\rect (a,b)$, обозначим её через $p$. Такая точка точно существует, потому что как минимум $a$ подойдёт, мы выбираем из непустого множества. Рассмотрим самую нижнюю, самую левую точку из $E(P)$, которая правее $\ell$, принадлежит $\rect (a,b)$ и не ниже $p$, обозначим её через $q$. Опять же такая найдётся, потому что есть $b$.

\newclm{Точки $p$ и $q$ лежат на одной горизонтали.}

Иначе образованный ими прямоугольник должен быть \arbs, и это бы значило, что мы неправильно выбрали $p$, $q$ (найдётся точка из $E(P)$, принадлежащая прямоугольнику $\rect (p,q)$ и лежащая ближе к $\ell$). Сопоставим прямоугольнику $\rect (a,b)$ горизонтальный отрезок $pq$, удалим этот прямоугольник из набора и продолжим сопоставление.

\newclm{Каждый отрезок $pq$ сопоставлен не более чем одному $\rect(a,b)$ из набора независимых прямоугольников.}

Потому что $pq$ лежит внутри $\rect(a,b)$ и пересекает линию, которую не пересекает больше никто из прямоугольников набора, имеющих общие точки с $\rect(a,b)$. Остальные прямоугольники из выбранных нами независимых просто не пересекаются с $\rect(a,b)$.

Рассмотрим точки $p_1 \ldots p_t$, $q_1 \ldots q_t$, отрезки с концами в которых были сопоставлены некоторым прямоугольникам и которые все оказались на одной горизонтальной прямой.

\begin{clm} \label{clm:sosed}
	Точки $p_i$, $q_i$ (соответствующие одному прямоугольнику) — соседние из отмеченных точек на этой горизонтальной прямой.
\end{clm}

В противном случае отрезок $p_i q_i$ будет пересекать какой-то другой отрезок $p_j q_j$. И в процессе сопоставления точек соответствующим прямоугольникам мы бы взяли какие-то другие точки.

\begin{figure}[h] \centering
	\tikz{
	\draw[->,thick] (0,0) -- (8,0);
	\filldraw (1.7,0) circle[radius=0.8mm] node[above]{$s \in P$};
	\foreach \x in {1,1.5,2.5,3.25,4.2} \draw (1.7 cm + \x cm,0) node{$\times$};
	}
\caption{Точки, добавленные в данную строку}
\label{fig:nPoints}
\end{figure}

Рассмотрим некоторую строку, в ней находится одна точка из исходного множества запросов $P$, смотреть Рисунок~\ref{fig:nPoints}. Пусть мы добавили в эту строку ещё $n$ точек, сопоставленных различным независимым прямоугольникам. Тогда точек стало $n+1$, и наибольшее число прямоугольников, которое может им соответствовать, — $n$, потому что Утверждение~\ref{clm:sosed}. То есть на одну точку из $E(P)$ добавляется не более одного прямоугольника. Лемма доказана.
\end{proof}

\begin{proof}[Доказательство теоремы~\ref{thm:optFirstBound}]
\begin{equation*}
	\opt\ \ge\ \max \parens{ \opt_+, \opt_- }.
\end{equation*} \vspace{-8mm}

Теперь воспользуемся тем, что максимум не меньше среднего, а также леммой~\ref{lm:optPlusBound}. \vspace{-5mm}

\begin{align*}
	\max \parens{ \opt_+, \opt_- }\ & \ge\ |P| + \frac{1}{2}
	\parens{ \maxind_+ + \maxind_- }\ \ge \\
	& \ge\ |P| + \frac{1}{2} \cdot \maxind.
\end{align*}

\vspace{-8mm} \end{proof}